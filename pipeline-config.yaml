# CI/CD Pipeline Configuration for OpenClaw Agent System
# Windows 10/11 Deployment

pipeline:
  # ============================================
  # Repository Configuration
  # ============================================
  
  repository:
    url: https://github.com/openclaw/openclaw-windows
    branch: main
    webhook_secret: ${WEBHOOK_SECRET}
    
    # Branch protection
    protected_branches:
      - main
      - release/*
    
    # Required checks
    required_checks:
      - "build"
      - "test"
      - "security-scan"
  
  # ============================================
  # Build Configuration
  # ============================================
  
  build:
    agent: windows-2022
    
    environment:
      python_version: "3.11"
      node_version: "18"
      
    steps:
      - name: "Checkout Code"
        action: checkout
        
      - name: "Setup Python"
        action: setup-python
        version: "3.11"
        
      - name: "Install Dependencies"
        command: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt
        
      - name: "Run Linter"
        command: "pylint src/ --fail-under=8.0"
        continue_on_error: false
        
      - name: "Type Check"
        command: "mypy src/ --strict"
        continue_on_error: true
        
      - name: "Run Tests"
        command: "pytest tests/ --cov=src --cov-report=xml --cov-report=html"
        
      - name: "Security Scan"
        command: |
          bandit -r src/ -f json -o bandit-report.json
          safety check
        
      - name: "Build Package"
        command: |
          python setup.py bdist_wheel
          python setup.py bdist_msi
        
      - name: "Create Windows Service"
        command: "powershell .\\scripts\\build-service.ps1"
        
      - name: "Package Artifacts"
        command: |
          Compress-Archive -Path dist\* -DestinationPath openclaw-${VERSION}.zip
          Compress-Archive -Path config\* -DestinationPath openclaw-config-${VERSION}.zip
  
  # ============================================
  # Test Configuration
  # ============================================
  
  test:
    stages:
      - name: "Unit Tests"
        command: "pytest tests/unit -v --tb=short"
        timeout: 300
        required: true
        
      - name: "Integration Tests"
        command: "pytest tests/integration -v --tb=short"
        timeout: 600
        required: true
        
      - name: "E2E Tests"
        command: "pytest tests/e2e -v --tb=short"
        timeout: 900
        required: false
        
      - name: "Performance Tests"
        command: "pytest tests/performance -v"
        timeout: 600
        required: false
        only_on_branch:
          - main
          - perf/*
  
  # ============================================
  # Deployment Strategies
  # ============================================
  
  deployment:
    staging:
      environment: staging
      strategy: blue-green
      auto_deploy: true
      require_approval: false
      
      pre_deploy:
        - verify_artifacts
        - run_smoke_tests
      
      post_deploy:
        - run_integration_tests
        - notify_team
    
    production:
      environment: production
      strategy: auto                    # auto-detect based on changes
      require_approval: true
      approval_timeout_hours: 24
      
      # Strategy selection criteria
      strategies:
        blue_green:
          trigger:
            - breaking_changes
            - database_migrations
            - major_version
            - configuration_changes
          
        canary:
          trigger:
            - high_risk_changes
            - new_features
            - ai_model_updates
          phases: [5, 10, 25, 50, 100]
          
        rolling:
          trigger:
            - default
            - bug_fixes
            - minor_updates
          batch_size: 2
      
      # Pre-deployment gates
      pre_deploy:
        - verify_artifacts
        - run_smoke_tests
        - security_approval
        - require_manual_approval
      
      # Post-deployment verification
      post_deploy:
        - run_health_checks
        - monitor_metrics
        - notify_team
        - update_documentation
  
  # ============================================
  # Artifact Management
  # ============================================
  
  artifacts:
    storage: azure_blob                 # azure_blob, s3, or local
    container: openclaw-artifacts
    retention_days: 90
    
    naming:
      pattern: "openclaw-{version}-{build_number}"
      
    # What to archive
    archive:
      - "dist/*.whl"
      - "dist/*.msi"
      - "config/*.yaml"
      - "scripts/*.ps1"
      - "docs/*.md"
  
  # ============================================
  # Notifications
  # ============================================
  
  notifications:
    slack:
      enabled: true
      webhook: ${SLACK_WEBHOOK_URL}
      channels:
        default: "#deployments"
        on_failure: "#alerts-critical"
      
      events:
        - pipeline_started
        - pipeline_completed
        - deployment_started
        - deployment_completed
        - deployment_failed
        - rollback_initiated
    
    email:
      enabled: true
      recipients:
        - devops@openclaw.io
        - oncall@openclaw.io
      
      events:
        - pipeline_failed
        - deployment_failed
        - rollback_completed
    
    webhook:
      enabled: false
      url: https://monitoring.openclaw.io/pipeline-events
  
  # ============================================
  # Security
  # ============================================
  
  security:
    # Secrets management
    secrets:
      provider: azure_keyvault
      keyvault_name: openclaw-secrets
      
    # Code signing
    code_signing:
      enabled: true
      certificate: ${CODE_SIGNING_CERT}
      
    # SAST/DAST
    sast:
      enabled: true
      tools:
        - bandit
        - semgrep
        
    dast:
      enabled: false
      
    # Dependency scanning
    dependency_scan:
      enabled: true
      tools:
        - safety
        - snyk
  
  # ============================================
  # Caching
  # ============================================
  
  cache:
    enabled: true
    
    paths:
      - "~/.pip/cache"
      - "node_modules"
      - ".pytest_cache"
    
    key: "{{ checksum 'requirements.txt' }}-{{ checksum 'requirements-dev.txt' }}"
  
  # ============================================
  # Triggers
  # ============================================
  
  triggers:
    push:
      branches:
        - main
        - release/*
        - feature/*
      
    pull_request:
      branches:
        - main
        - release/*
      
    schedule:
      - cron: "0 2 * * *"              # Nightly build at 2 AM
        branches:
          - main
      
    manual:
      enabled: true
      require_approval: true
