# Ralph Loop Configuration
# Multi-Layered Background Processing with Priority Queuing
# OpenClaw Windows 10 AI Agent System

ralph_loop:
  # =============================================================================
  # LAYER CONFIGURATION
  # =============================================================================
  layers:
    critical:
      layer_id: 0
      name: "Critical Layer"
      description: "System-critical operations requiring immediate execution"
      latency_target_ms: 1
      cpu_allocation_percent: 40
      memory_allocation_mb: 512
      preemption_level: "absolute"
      max_concurrent: 10
      timeout_ms: 5
      task_types:
        - system_health_check
        - emergency_shutdown
        - security_breach_response
        - memory_critical_alert
        - heartbeat_missed_recovery
        - identity_corruption_detected
        
    real_time:
      layer_id: 1
      name: "Real-Time Layer"
      description: "Time-sensitive operations with strict deadlines"
      latency_target_ms: 10
      cpu_allocation_percent: 25
      memory_allocation_mb: 1024
      preemption_level: "high"
      max_concurrent: 20
      timeout_ms: 50
      task_types:
        - voice_stream_processing
        - stt_realtime_conversion
        - tts_stream_generation
        - twilio_call_handling
        - browser_event_response
        - user_input_processing
        
    high_priority:
      layer_id: 2
      name: "High-Priority Layer"
      description: "User-facing operations requiring quick response"
      latency_target_ms: 100
      cpu_allocation_percent: 20
      memory_allocation_mb: 2048
      preemption_level: "medium"
      max_concurrent: 50
      timeout_ms: 500
      task_types:
        - gmail_send_receive
        - browser_navigation
        - api_request_processing
        - notification_delivery
        - user_command_execution
        - context_switching
        
    standard:
      layer_id: 3
      name: "Standard Layer"
      description: "Normal processing operations"
      latency_target_ms: 1000
      cpu_allocation_percent: 10
      memory_allocation_mb: 4096
      preemption_level: "low"
      max_concurrent: 100
      timeout_ms: 5000
      task_types:
        - agent_loop_execution
        - data_processing
        - file_operations
        - scheduled_task_execution
        - cache_management
        - logging_operations
        
    background:
      layer_id: 4
      name: "Background Layer"
      description: "Deferred operations that can wait"
      latency_target_ms: 10000
      cpu_allocation_percent: 3
      memory_allocation_mb: 1024
      preemption_level: "none"
      max_concurrent: 50
      timeout_ms: 30000
      task_types:
        - log_rotation
        - cache_cleanup
        - temporary_file_cleanup
        - index_optimization
        - background_sync
        - metrics_aggregation
        
    batch:
      layer_id: 5
      name: "Batch Layer"
      description: "Bulk processing operations"
      latency_target_ms: 300000
      cpu_allocation_percent: 1.5
      memory_allocation_mb: 2048
      preemption_level: "none"
      max_concurrent: 20
      timeout_ms: 600000
      task_types:
        - bulk_email_processing
        - large_file_operations
        - data_export_import
        - report_generation
        - ml_model_training
        - historical_analysis
        
    archival:
      layer_id: 6
      name: "Archival Layer"
      description: "Historical operations and long-term storage"
      latency_target_ms: null  # Best effort
      cpu_allocation_percent: 0.5
      memory_allocation_mb: 512
      preemption_level: "none"
      max_concurrent: 10
      timeout_ms: 3600000
      task_types:
        - conversation_archival
        - long_term_storage
        - data_compression
        - historical_backup
        - audit_log_archival
        - cold_storage_operations

  # =============================================================================
  # PRIORITY QUEUE CONFIGURATION
  # =============================================================================
  queue:
    max_size: 100000
    default_priority: 64  # P64_AGENT_LOOP
    
    # Priority aging configuration
    aging:
      enabled: true
      interval_seconds: 60
      max_boost: 10  # Maximum priority boost from aging
    
    # Deadline handling
    deadlines:
      enabled: true
      overdue_boost: 50
      imminent_threshold_seconds: 10
      imminent_boost: 30
      approaching_threshold_seconds: 60
      approaching_boost: 15
    
    # Preemption tracking
    preemption:
      boost_per_preemption: 2
      max_preemptions: 10

  # =============================================================================
  # PERSISTENCE CONFIGURATION
  # =============================================================================
  persistence:
    enabled: true
    
    # SQLite database
    database:
      db_path: "data/ralph_queue.db"
      wal_mode: true
      synchronous: "NORMAL"
      journal_mode: "WAL"
      
    # Write-ahead log
    wal:
      enabled: true
      log_path: "data/ralph_wal.log"
      flush_interval_ms: 100
      max_log_size_mb: 100
      
    # Checkpoint configuration
    checkpoints:
      enabled: true
      interval_seconds: 300
      max_checkpoints_per_task: 10
      compression: true
      
    # Cleanup
    cleanup:
      interval_hours: 24
      max_age_days: 7
      vacuum_threshold_mb: 100

  # =============================================================================
  # RESOURCE SCHEDULING CONFIGURATION
  # =============================================================================
  scheduling:
    algorithm: "MLFQ"  # Multi-Level Feedback Queue
    
    # Time quantum configuration
    quantum:
      base_ms: 100
      multipliers: [1, 2, 4, 8, 16, 32, 64]
      io_bound_factor: 0.5
      cpu_intensive_factor: 1.5
    
    # Fair share scheduling
    fair_share:
      enabled: true
      groups:
        system:
          shares: 10
        user:
          shares: 5
        background:
          shares: 1
      throttle_threshold: 1.5

  # =============================================================================
  # PREEMPTION CONFIGURATION
  # =============================================================================
  preemption:
    enabled: true
    
    # Preemption policies by layer
    policies:
      critical:
        can_preempt: [real_time, high_priority, standard, background, batch, archival]
      real_time:
        can_preempt: [high_priority, standard, background, batch, archival]
      high_priority:
        can_preempt: [standard, background, batch, archival]
      standard:
        can_preempt: [background, batch, archival]
      background:
        can_preempt: [batch, archival]
      batch:
        can_preempt: [archival]
      archival:
        can_preempt: []
    
    # Checkpoint configuration
    checkpoint:
      auto_checkpoint: true
      interval_ms: 5000
      on_preemption: true
      
    # Resumption
    resumption:
      auto_resume: true
      priority_boost_enabled: true
      max_wait_boost: 20

  # =============================================================================
  # LOAD BALANCING CONFIGURATION
  # =============================================================================
  load_balancing:
    enabled: true
    
    # Assessment interval
    assessment:
      interval_seconds: 5
      
    # Imbalance detection
    imbalance:
      threshold: 0.3  # 30% difference triggers rebalance
      
    # Work stealing
    work_stealing:
      enabled: true
      num_workers: 8
      steal_from_bottom: true
      
    # Backpressure
    backpressure:
      enabled: true
      thresholds:
        warning: 1000
        throttle: 5000
        reject: 10000
      throttle_delay_max_seconds: 5

  # =============================================================================
  # RECOVERY CONFIGURATION
  # =============================================================================
  recovery:
    auto_recover: true
    recovery_timeout_seconds: 30
    
    # Consistency checking
    consistency:
      enabled: true
      check_dependencies: true
      check_cycles: true
      
    # Orphaned data handling
    orphans:
      cleanup: true
      max_age_hours: 24

  # =============================================================================
  # MONITORING CONFIGURATION
  # =============================================================================
  monitoring:
    enabled: true
    
    # Metrics collection
    metrics:
      interval_seconds: 10
      retention_hours: 168  # 7 days
      
      # Collected metrics
      collect:
        queue_depth: true
        throughput: true
        latency: true
        cpu_usage: true
        memory_usage: true
        io_stats: true
        
    # Health checks
    health:
      interval_seconds: 30
      checks:
        queue_depth: true
        memory_pressure: true
        cpu_saturation: true
        disk_space: true
        
    # Profiling
    profiling:
      enabled: true
      sample_rate: 0.1
      profile_layers: [0, 1, 2, 3]

  # =============================================================================
  # ALERTING CONFIGURATION
  # =============================================================================
  alerting:
    enabled: true
    
    # Alert channels
    channels:
      log:
        enabled: true
        level: "warning"
        
      windows_event:
        enabled: true
        level: "error"
        source: "RalphLoop"
        
      webhook:
        enabled: false
        url: "${ALERT_WEBHOOK_URL}"
        level: "critical"
        timeout_seconds: 5
        
      email:
        enabled: false
        smtp_server: "${SMTP_SERVER}"
        smtp_port: 587
        username: "${SMTP_USERNAME}"
        password: "${SMTP_PASSWORD}"
        from_address: "ralph@openclaw.local"
        to_addresses: ["admin@openclaw.local"]
        level: "critical"
    
    # Alert rules
    rules:
      - name: "high_queue_depth"
        condition: "queue_depth > 5000"
        level: "warning"
        message: "Queue depth exceeds 5000 tasks"
        channels: ["log"]
        suppress_duration_minutes: 5
        
      - name: "critical_queue_depth"
        condition: "queue_depth > 10000"
        level: "critical"
        message: "Queue depth exceeds 10000 tasks - rejecting new tasks"
        channels: ["log", "windows_event"]
        suppress_duration_minutes: 1
        
      - name: "critical_latency"
        condition: "layer_0_latency_ms > 5"
        level: "critical"
        message: "Critical layer latency exceeds 5ms"
        channels: ["log", "windows_event"]
        suppress_duration_minutes: 1
        
      - name: "memory_pressure"
        condition: "memory_usage_percent > 90"
        level: "critical"
        message: "Memory usage exceeds 90%"
        channels: ["log", "windows_event"]
        suppress_duration_minutes: 2
        
      - name: "high_memory"
        condition: "memory_usage_percent > 80"
        level: "warning"
        message: "Memory usage exceeds 80%"
        channels: ["log"]
        suppress_duration_minutes: 5
        
      - name: "cpu_saturation"
        condition: "cpu_usage_percent > 90"
        level: "warning"
        message: "CPU usage exceeds 90%"
        channels: ["log"]
        suppress_duration_minutes: 5
        
      - name: "task_failure_rate"
        condition: "task_failure_rate > 0.1"
        level: "error"
        message: "Task failure rate exceeds 10%"
        channels: ["log", "windows_event"]
        suppress_duration_minutes: 10

  # =============================================================================
  # SECURITY CONFIGURATION
  # =============================================================================
  security:
    # Task validation
    validation:
      enabled: true
      whitelist_task_types: true
      check_suspicious_content: true
      
    # Sandbox execution
    sandbox:
      enabled: true
      default_memory_limit_mb: 512
      default_cpu_limit_percent: 50
      network_access: false
      file_access: "restricted"
      
    # Allowed paths for file operations
    allowed_paths:
      - "data/"
      - "logs/"
      - "temp/"

  # =============================================================================
  # CRON JOB CONFIGURATION
  # =============================================================================
  cron_jobs:
    - name: "heartbeat"
      task_type: "heartbeat_check"
      cron_expression: "*/30 * * * * *"  # Every 30 seconds
      priority: 0
      enabled: true
      
    - name: "identity_verification"
      task_type: "identity_verification"
      cron_expression: "0 */5 * * * *"  # Every 5 minutes
      priority: 0
      enabled: true
      
    - name: "log_rotation"
      task_type: "log_rotation"
      cron_expression: "0 0 * * * *"  # Every hour
      priority: 128
      enabled: true
      
    - name: "cache_cleanup"
      task_type: "cache_cleanup"
      cron_expression: "0 */15 * * * *"  # Every 15 minutes
      priority: 130
      enabled: true
      
    - name: "metrics_aggregation"
      task_type: "metrics_aggregation"
      cron_expression: "0 */5 * * * *"  # Every 5 minutes
      priority: 140
      enabled: true
      
    - name: "conversation_archival"
      task_type: "conversation_archival"
      cron_expression: "0 0 0 * * *"  # Daily at midnight
      priority: 240
      enabled: true

  # =============================================================================
  # OPENCLAW INTEGRATION
  # =============================================================================
  openclaw:
    # Agent loop coordination
    agent_loops:
      - name: "perception_loop"
        priority: 20
        layer: 1
        
      - name: "cognition_loop"
        priority: 64
        layer: 3
        
      - name: "action_loop"
        priority: 40
        layer: 2
        
      - name: "memory_loop"
        priority: 90
        layer: 3
        
      - name: "learning_loop"
        priority: 210
        layer: 5
        
      - name: "communication_loop"
        priority: 32
        layer: 2
        
      - name: "safety_loop"
        priority: 1
        layer: 0
        
      - name: "identity_loop"
        priority: 0
        layer: 0
        
      - name: "goal_loop"
        priority: 65
        layer: 3
        
      - name: "planning_loop"
        priority: 65
        layer: 3
        
      - name: "reflection_loop"
        priority: 140
        layer: 4
        
      - name: "emotion_loop"
        priority: 150
        layer: 4
        
      - name: "social_loop"
        priority: 150
        layer: 4
        
      - name: "ralph_loop"
        priority: 0
        layer: 0
        
      - name: "orchestration_loop"
        priority: 0
        layer: 0

  # =============================================================================
  # PERFORMANCE TARGETS
  # =============================================================================
  performance:
    targets:
      layer_0_latency_ms: 1
      layer_1_latency_ms: 10
      layer_2_latency_ms: 100
      context_switch_us: 100
      queue_throughput_per_second: 10000
      recovery_time_seconds: 30
      checkpoint_overhead_percent: 5
      
    limits:
      max_concurrent_tasks: 100000
      max_queue_depth: 1000000
      max_layers: 16
      max_priority_levels: 256
      max_workers_per_layer: 64
