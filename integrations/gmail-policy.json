{
  "version": "1.0.0",
  "provider": "google-gmail",
  "description": "Complete Gmail Pub/Sub operational policy for AlwaysClaw integration layer",
  "watchLifecycle": {
    "maxWatchLifetimeDays": 7,
    "recommendedRenewalCadence": "daily",
    "renewalJitterMinutes": 15,
    "persistedState": ["historyId", "expiration", "lastSyncAt"],
    "renewalTrigger": "cron",
    "renewalLoopId": "gmail-watch-renewal-loop-v1",
    "initialSetup": {
      "requiredScopes": [
        "https://www.googleapis.com/auth/gmail.modify",
        "https://www.googleapis.com/auth/gmail.send"
      ],
      "topicName": "projects/<project-id>/topics/gmail-push",
      "subscriptionName": "projects/<project-id>/subscriptions/gmail-push-sub",
      "labelIds": ["INBOX"],
      "labelFilterBehavior": "INCLUDE"
    },
    "renewalPolicy": {
      "method": "users.watch",
      "preExpiryBufferHours": 12,
      "maxConsecutiveRenewalFailures": 3,
      "onRenewalFailure": "alert-owner-and-fallback-to-polling",
      "pollingFallbackIntervalMinutes": 5
    }
  },
  "notificationProcessing": {
    "ackPolicy": "immediate-http-2xx",
    "maxAckDelaySec": 10,
    "processingPipeline": [
      "validate-jwt-authenticity",
      "parse-notification-envelope",
      "extract-history-id",
      "check-deduplication-window",
      "enqueue-mailbox-sync-job",
      "execute-history-delta-sync"
    ],
    "historyDeltaSync": {
      "method": "users.history.list",
      "parameter": "startHistoryId=lastHistoryId",
      "historyTypes": [
        "messageAdded",
        "messageDeleted",
        "labelAdded",
        "labelRemoved"
      ],
      "on404": "trigger-full-resync",
      "fullResyncLoopId": "gmail-full-resync-loop-v1",
      "batchSize": 100,
      "paginationMaxPages": 10,
      "paginationTokenField": "nextPageToken",
      "responseFields": ["history", "historyId", "nextPageToken"],
      "postSyncAction": "update-persisted-historyId"
    },
    "rateLimiting": {
      "maxEventsPerSecondPerUser": 1,
      "backoffOnThrottle": "exponential",
      "initialBackoffSeconds": 2,
      "maxBackoffSeconds": 300,
      "quotaUnit": "per-user-per-second",
      "dailyQuotaUnits": 250000000,
      "perUserRateLimitPerSecond": 25
    },
    "deduplication": {
      "method": "historyId-based",
      "windowSeconds": 300,
      "storageKey": "gmail:dedup:{userId}",
      "storageBackend": "in-memory-with-disk-fallback",
      "evictionPolicy": "ttl-based"
    }
  },
  "security": {
    "pushAuthentication": {
      "method": "jwt-bearer-token",
      "validationRequired": true,
      "claims": {
        "issuer": "accounts.google.com",
        "audience": "<configured-endpoint-url>",
        "serviceAccount": "<push-subscription-service-account>"
      },
      "validationSteps": [
        "verify-jwt-signature-against-google-certs",
        "check-token-expiry",
        "validate-issuer-claim",
        "validate-audience-claim",
        "validate-service-account-claim"
      ],
      "googleCertsUrl": "https://www.googleapis.com/oauth2/v3/certs",
      "certsCacheTtlSeconds": 3600,
      "rejectUnauthenticated": true,
      "securityEventOnFailure": "high-severity",
      "logRejections": true,
      "rejectionResponseCode": 401
    },
    "tokenManagement": {
      "refreshTokenStorage": "encrypted-vault",
      "accessTokenTtlSeconds": 3600,
      "refreshBeforeExpirySeconds": 300,
      "rotationPolicy": "on-compromise-or-quarterly",
      "encryptionAlgorithm": "aes-256-gcm",
      "vaultPath": "state/auth/gmail/tokens.enc",
      "maxRefreshRetries": 3,
      "onRefreshFailure": "alert-owner-and-disable-integration"
    },
    "webhookEndpoint": {
      "requiredTls": true,
      "minTlsVersion": "1.2",
      "allowedSourceIps": "google-pubsub-ip-ranges",
      "rateLimitInbound": 100,
      "rateLimitWindowSeconds": 60
    }
  },
  "reliability": {
    "periodicHistoryFallback": {
      "enabled": true,
      "cadence": "every-15-minutes",
      "purpose": "catch-dropped-or-delayed-notifications",
      "loopId": "gmail-history-delta-sync-loop-v1",
      "maxHistoryIdGap": 1000,
      "alertOnLargeGap": true
    },
    "staleHistoryRecovery": {
      "trigger": "http-404-from-history-list",
      "action": "full-mailbox-resync-and-reset-baseline",
      "loopId": "gmail-full-resync-loop-v1",
      "maxResyncThreads": 500,
      "resyncBatchSize": 50,
      "resyncPaginationMaxPages": 20,
      "resyncTimeout": "10m",
      "postResyncAction": "persist-new-baseline-historyId"
    },
    "watchExpiry": {
      "detectionMethod": "cron-check-expiration-timestamp",
      "gracePeriodMinutes": 60,
      "alertOnMissedRenewal": true,
      "alertChannel": "incident-containment-loop",
      "autoRenewOnDetection": true
    },
    "circuitBreaker": {
      "enabled": true,
      "failureThreshold": 5,
      "resetTimeoutSeconds": 120,
      "halfOpenMaxAttempts": 2,
      "monitoredOperations": ["history.list", "users.watch", "messages.get"]
    }
  },
  "actionPolicy": {
    "readOperations": {
      "tier": "tier0-readonly",
      "approvalRequired": false,
      "operations": [
        "messages.get",
        "messages.list",
        "threads.get",
        "threads.list",
        "labels.list",
        "labels.get",
        "history.list",
        "users.getProfile"
      ],
      "rateLimit": "25-per-second-per-user"
    },
    "labelArchiveOperations": {
      "tier": "tier1-reversible",
      "approvalRequired": false,
      "operations": [
        "messages.modify",
        "messages.batchModify",
        "labels.create",
        "labels.update"
      ],
      "auditLog": true,
      "rollbackSupported": true
    },
    "sendForwardDeleteOperations": {
      "tier": "tier2-irreversible",
      "approvalRequired": true,
      "operations": [
        "messages.send",
        "messages.trash",
        "messages.delete",
        "drafts.send",
        "drafts.create",
        "messages.import"
      ],
      "approvalTimeout": "5m",
      "approvalEscalation": "timeout-then-deny",
      "auditLog": true,
      "rollbackSupported": false
    }
  },
  "relatedLoops": [
    "gmail-watch-renewal-loop-v1",
    "gmail-notification-intake-loop-v1",
    "gmail-history-delta-sync-loop-v1",
    "gmail-full-resync-loop-v1",
    "gmail-action-execution-loop-v1"
  ],
  "errorHandling": {
    "on400": "log-bad-request-and-skip",
    "on401": "refresh-token-and-retry",
    "on403": "log-permission-error-alert-owner",
    "on404": "trigger-full-resync-if-history-else-skip",
    "on429": "exponential-backoff-with-jitter",
    "on5xx": "retry-3-times-then-dead-letter",
    "onNetworkError": "retry-with-circuit-breaker",
    "onTimeout": "retry-once-then-dead-letter",
    "deadLetterQueue": {
      "enabled": true,
      "maxRetentionHours": 72,
      "replayPolicy": "manual-or-scheduled",
      "storageKey": "gmail:dlq:{userId}"
    },
    "alerting": {
      "consecutiveFailureThreshold": 3,
      "alertChannel": "incident-containment-loop",
      "includeErrorContext": true,
      "redactSensitiveFields": ["accessToken", "refreshToken", "emailBody"]
    }
  },
  "observability": {
    "metrics": [
      "gmail.watch.renewals.total",
      "gmail.watch.renewals.failures",
      "gmail.notifications.received",
      "gmail.notifications.processed",
      "gmail.notifications.deduplicated",
      "gmail.history.syncs.total",
      "gmail.history.syncs.failures",
      "gmail.full_resync.triggered",
      "gmail.actions.executed",
      "gmail.actions.approval_pending",
      "gmail.errors.by_status_code"
    ],
    "tracing": {
      "spanNamePrefix": "gmail",
      "captureHistoryId": true,
      "captureMessageCount": true,
      "redactMessageContent": true
    }
  }
}
