{
  "version": "1.0.0",
  "provider": "twilio",
  "description": "Complete Twilio SMS and Voice operational policy for AlwaysClaw integration layer",
  "webhookSecurity": {
    "signatureValidation": {
      "method": "X-Twilio-Signature",
      "headerName": "X-Twilio-Signature",
      "lowercaseHeaderVariant": "x-twilio-signature",
      "lowercaseUsedFor": "websocket-handshake-requests",
      "validationApproach": "sdk-validator",
      "sdkMethod": "twilio.validateRequest(authToken, signature, url, params)",
      "rejectUnsigned": true,
      "securityEventOnInvalid": "high-severity",
      "logRejections": true,
      "rejectionResponseCode": 403
    },
    "endpointSecurity": {
      "requiredTls": true,
      "minTlsVersion": "1.2",
      "allowedSourceIps": "twilio-signaling-ip-ranges",
      "rateLimitInbound": 200,
      "rateLimitWindowSeconds": 60,
      "idempotencyEnforcement": true
    },
    "authTokenManagement": {
      "storage": "encrypted-vault",
      "vaultPath": "state/auth/twilio/credentials.enc",
      "encryptionAlgorithm": "aes-256-gcm",
      "rotationPolicy": "on-compromise-or-quarterly",
      "rotationSteps": [
        "generate-secondary-auth-token",
        "update-vault-with-secondary",
        "promote-secondary-to-primary",
        "revoke-old-primary"
      ]
    }
  },
  "smsOperations": {
    "outbound": {
      "apiEndpoint": "https://api.twilio.com/2010-04-01/Accounts/{AccountSid}/Messages.json",
      "method": "POST",
      "idempotencyKey": {
        "header": "I-Idempotency-Key",
        "format": "uuid-v4",
        "required": true,
        "storageKey": "twilio:sms:idempotency:{messageId}",
        "ttlSeconds": 86400
      },
      "maxMessageLength": {
        "singleSegment": 160,
        "concatenatedMax": 1600,
        "characterEncoding": "GSM-7 preferred, UCS-2 fallback",
        "autoDetectEncoding": true
      },
      "requiredFields": ["To", "From", "Body"],
      "optionalFields": ["StatusCallback", "MessagingServiceSid", "MediaUrl"],
      "statusCallbackUrl": "<configured-sms-callback-endpoint>",
      "rateLimiting": {
        "maxOutboundPerSecond": 10,
        "maxOutboundPerDay": 10000,
        "backoffOnThrottle": "exponential",
        "maxBackoffSeconds": 120
      }
    },
    "inbound": {
      "webhookReceiverPath": "/webhooks/twilio/sms/inbound",
      "signatureValidation": "required",
      "expectedFields": [
        "MessageSid", "AccountSid", "From", "To", "Body",
        "NumMedia", "NumSegments", "SmsStatus"
      ],
      "responseFormat": "twiml",
      "twimlResponseTemplate": "<Response><Message>{responseBody}</Message></Response>",
      "emptyResponseOnNoReply": "<Response></Response>",
      "maxProcessingTimeSec": 10,
      "onProcessingTimeout": "return-empty-twiml-and-enqueue"
    },
    "statusCallbacks": {
      "stateProgression": [
        "queued",
        "sending",
        "sent",
        "delivered",
        "failed",
        "undelivered"
      ],
      "terminalStates": ["delivered", "failed", "undelivered"],
      "callbackFields": [
        "MessageSid", "MessageStatus", "To", "From",
        "ErrorCode", "ErrorMessage"
      ],
      "reconciliation": {
        "cadence": "every-5-minutes",
        "purpose": "detect-orphaned-messages-without-terminal-callback",
        "maxOrphanAgeMinutes": 30,
        "onOrphanDetected": "query-message-status-api-and-reconcile",
        "loopId": "twilio-sms-delivery-reconciliation-loop-v1"
      },
      "idempotentHandling": true,
      "deduplication": {
        "method": "sid-timestamp-hash",
        "hashFields": ["MessageSid", "MessageStatus", "Timestamp"],
        "windowSeconds": 600,
        "storageKey": "twilio:sms:dedup:{messageSid}"
      }
    }
  },
  "voiceOperations": {
    "outbound": {
      "apiEndpoint": "https://api.twilio.com/2010-04-01/Accounts/{AccountSid}/Calls.json",
      "method": "POST",
      "requiredFields": ["To", "From", "Url"],
      "optionalFields": ["StatusCallback", "StatusCallbackEvent", "Timeout", "Record"],
      "twimlGeneration": {
        "method": "dynamic-twiml-endpoint",
        "endpointPath": "/webhooks/twilio/voice/twiml",
        "supportedVerbs": ["Say", "Gather", "Dial", "Play", "Record", "Pause", "Stream"],
        "defaultVoice": "Polly.Matthew",
        "defaultLanguage": "en-US"
      },
      "cpsTracking": {
        "maxCallsPerSecond": 1,
        "burstLimit": 5,
        "trackingKey": "twilio:voice:cps:{accountSid}",
        "windowSeconds": 1,
        "onCpsExceeded": "queue-and-retry-with-backoff"
      },
      "callTimeout": {
        "ringingTimeoutSec": 30,
        "maxCallDurationSec": 3600,
        "defaultTimeoutSec": 60
      }
    },
    "inbound": {
      "webhookReceiverPath": "/webhooks/twilio/voice/inbound",
      "signatureValidation": "required",
      "expectedFields": [
        "CallSid", "AccountSid", "From", "To", "CallStatus",
        "Direction", "ApiVersion"
      ],
      "responseFormat": "twiml",
      "twimlResponseTemplate": "<Response>{twimlVerbs}</Response>",
      "maxProcessingTimeSec": 5,
      "onProcessingTimeout": "return-hold-music-twiml"
    },
    "statusCallbacks": {
      "stateProgression": [
        "initiated",
        "ringing",
        "in-progress",
        "completed",
        "busy",
        "no-answer",
        "canceled",
        "failed"
      ],
      "terminalStates": ["completed", "busy", "no-answer", "canceled", "failed"],
      "subscribedEvents": ["initiated", "ringing", "answered", "completed"],
      "callbackFields": [
        "CallSid", "CallStatus", "CallDuration", "Direction",
        "From", "To", "Timestamp"
      ],
      "idempotentHandling": true,
      "deduplication": {
        "method": "sid-status-timestamp-hash",
        "hashFields": ["CallSid", "CallStatus", "Timestamp"],
        "windowSeconds": 600,
        "storageKey": "twilio:voice:dedup:{callSid}"
      }
    },
    "streamBridge": {
      "protocol": "websocket",
      "direction": "bidirectional",
      "codec": "mulaw",
      "sampleRate": 8000,
      "channels": 1,
      "streamUrl": "wss://<configured-stream-endpoint>/webhooks/twilio/voice/stream",
      "twimlStreamVerb": "<Stream url='{streamUrl}' track='both_tracks'/>",
      "mediaFormat": {
        "inbound": "base64-encoded-mulaw-payload",
        "outbound": "base64-encoded-mulaw-payload",
        "chunkSizeMs": 20
      },
      "connectionLifecycle": {
        "onConnect": "initialize-stt-tts-pipeline",
        "onMedia": "forward-to-stt-stream",
        "onStop": "flush-stt-buffer-and-finalize",
        "onDisconnect": "cleanup-session-resources",
        "heartbeatIntervalSec": 30,
        "idleTimeoutSec": 120
      },
      "signatureValidation": {
        "header": "x-twilio-signature",
        "note": "lowercase header used in WebSocket handshake",
        "validationRequired": true
      }
    }
  },
  "reliability": {
    "deliveryCallbackReconciliation": {
      "enabled": true,
      "cadence": "every-5-minutes",
      "purpose": "detect-orphaned-messages-or-calls-missing-terminal-callback",
      "loopId": "twilio-sms-delivery-reconciliation-loop-v1",
      "queryApi": {
        "sms": "https://api.twilio.com/2010-04-01/Accounts/{AccountSid}/Messages/{Sid}.json",
        "voice": "https://api.twilio.com/2010-04-01/Accounts/{AccountSid}/Calls/{Sid}.json"
      },
      "maxOrphanAgeMinutes": 30,
      "maxReconciliationBatchSize": 50
    },
    "deadLetterHandling": {
      "enabled": true,
      "queue": "twilio:dlq:{operationType}",
      "maxRetentionHours": 72,
      "maxRetries": 3,
      "replayPolicy": "manual-or-scheduled",
      "onMaxRetriesExceeded": "alert-owner-and-archive"
    },
    "retryPolicy": {
      "maxAttempts": 3,
      "backoffStrategy": "exponential-with-jitter",
      "initialBackoffMs": 1000,
      "maxBackoffMs": 30000,
      "jitterPercent": 25,
      "retryableErrors": [
        "network-timeout",
        "http-429",
        "http-500",
        "http-502",
        "http-503"
      ],
      "nonRetryableErrors": [
        "http-400",
        "http-401",
        "http-403",
        "http-404",
        "invalid-phone-number"
      ]
    },
    "circuitBreaker": {
      "enabled": true,
      "failureThreshold": 5,
      "resetTimeoutSeconds": 60,
      "halfOpenMaxAttempts": 2,
      "monitoredOperations": ["sms.send", "calls.create", "webhook.process"]
    }
  },
  "actionPolicy": {
    "readOperations": {
      "tier": "tier0-readonly",
      "approvalRequired": false,
      "operations": [
        "messages.get",
        "messages.list",
        "calls.get",
        "calls.list",
        "accounts.get",
        "usage.records.list"
      ],
      "rateLimit": "25-per-second"
    },
    "writeOperations": {
      "tier": "tier1-reversible",
      "approvalRequired": false,
      "operations": [
        "messages.create",
        "calls.update",
        "twiml.generate"
      ],
      "auditLog": true,
      "rollbackSupported": true,
      "rollbackMethod": "cancel-in-progress-or-log-only"
    },
    "irreversibleOperations": {
      "tier": "tier2-irreversible",
      "approvalRequired": true,
      "operations": [
        "calls.create",
        "messages.bulk-send",
        "accounts.update",
        "phone-numbers.purchase",
        "phone-numbers.release"
      ],
      "approvalTimeout": "5m",
      "approvalEscalation": "timeout-then-deny",
      "auditLog": true,
      "rollbackSupported": false
    }
  },
  "relatedLoops": [
    "twilio-webhook-verification-loop-v1",
    "twilio-sms-inbound-processing-loop-v1",
    "twilio-sms-delivery-reconciliation-loop-v1",
    "twilio-voice-call-orchestration-loop-v1",
    "twilio-voice-callback-reconciliation-loop-v1"
  ],
  "errorHandling": {
    "on400": "log-bad-request-and-skip",
    "on401": "refresh-auth-token-and-retry",
    "on403": "log-permission-error-alert-owner",
    "on404": "log-resource-not-found-and-skip",
    "on429": "exponential-backoff-with-jitter",
    "on5xx": "retry-3-times-then-dead-letter",
    "onNetworkError": "retry-with-circuit-breaker",
    "onTimeout": "retry-once-then-dead-letter",
    "onInvalidSignature": "reject-and-log-security-event",
    "twilioErrorCodes": {
      "21211": "invalid-to-phone-number",
      "21612": "trial-account-unverified-number",
      "30003": "unreachable-destination",
      "30005": "unknown-destination",
      "30006": "landline-not-sms-capable",
      "30007": "carrier-content-filtering",
      "30008": "unknown-error"
    },
    "deadLetterQueue": {
      "enabled": true,
      "maxRetentionHours": 72,
      "replayPolicy": "manual-or-scheduled",
      "storageKey": "twilio:dlq:{operationType}:{sid}"
    },
    "alerting": {
      "consecutiveFailureThreshold": 3,
      "alertChannel": "incident-containment-loop",
      "includeErrorContext": true,
      "redactSensitiveFields": ["authToken", "callContent", "messageBody"]
    }
  },
  "observability": {
    "metrics": [
      "twilio.sms.outbound.total",
      "twilio.sms.outbound.failures",
      "twilio.sms.inbound.total",
      "twilio.sms.delivery.by_status",
      "twilio.sms.reconciliation.orphans_found",
      "twilio.voice.outbound.total",
      "twilio.voice.outbound.failures",
      "twilio.voice.inbound.total",
      "twilio.voice.duration.seconds",
      "twilio.voice.stream.connections",
      "twilio.webhook.signature.valid",
      "twilio.webhook.signature.invalid",
      "twilio.errors.by_code"
    ],
    "tracing": {
      "spanNamePrefix": "twilio",
      "captureMessageSid": true,
      "captureCallSid": true,
      "redactMessageBody": true,
      "redactPhoneNumbers": "partial-mask"
    }
  }
}
